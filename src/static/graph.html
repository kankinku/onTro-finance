<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OntoFin Knowledge Base</title>
    <!DOCTYPE html>
    <html lang="ko">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>OntoFin Knowledge Base</title>
        <link rel="stylesheet" as="style" crossorigin
            href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
        <style>
            :root {
                --bg-color: #101010;
                --surface-color: #202022;
                --surface-hover: #2c2c2e;
                --primary: #3182f6;
                --text-primary: #ffffff;
                --text-secondary: #b0b8c1;
                --text-tertiary: #6b7684;
                --line: #333335;
                --sidebar-width: 260px;
            }

            body {
                font-family: 'Pretendard', -apple-system, sans-serif;
                background-color: var(--bg-color);
                color: var(--text-primary);
                margin: 0;
                padding: 0;
                display: flex;
                min-height: 100vh;
            }

            /* Sidebar Navigation */
            .sidebar {
                width: var(--sidebar-width);
                background-color: var(--surface-color);
                border-right: 1px solid var(--line);
                padding: 24px;
                display: flex;
                flex-direction: column;
                position: fixed;
                height: 100vh;
                box-sizing: border-box;
                left: 0;
                top: 0;
                z-index: 1000;
            }

            .brand {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 40px;
                color: var(--text-primary);
                text-decoration: none;
                display: block;
            }

            .nav-item {
                display: block;
                padding: 12px 16px;
                margin-bottom: 8px;
                border-radius: 12px;
                color: var(--text-secondary);
                text-decoration: none;
                font-weight: 600;
                font-size: 16px;
                transition: all 0.2s;
            }

            .nav-item:hover {
                background-color: var(--surface-hover);
                color: var(--text-primary);
            }

            .nav-item.active {
                background-color: rgba(49, 130, 246, 0.1);
                color: var(--primary);
            }

            .nav-divider {
                height: 1px;
                background-color: var(--line);
                margin: 20px 0;
            }

            /* Main Content */
            .main-content {
                margin-left: var(--sidebar-width);
                flex: 1;
                padding: 40px 60px;
                width: calc(100% - var(--sidebar-width));
                box-sizing: border-box;
            }

            h1 {
                font-size: 28px;
                margin: 0 0 8px 0;
            }

            .subtitle {
                color: var(--text-secondary);
                font-size: 16px;
                margin-bottom: 32px;
            }

            /* Stats Row */
            .stats-row {
                display: flex;
                gap: 16px;
                margin-bottom: 32px;
            }

            .stat-card {
                background-color: var(--surface-color);
                padding: 24px;
                border-radius: 20px;
                flex: 1;
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .stat-value {
                font-size: 28px;
                font-weight: 700;
            }

            .stat-label {
                font-size: 14px;
                color: var(--text-secondary);
            }

            /* Tabs */
            .tabs {
                display: flex;
                gap: 20px;
                margin-bottom: 24px;
                border-bottom: 1px solid var(--line);
            }

            .tab {
                padding: 12px 0;
                cursor: pointer;
                font-weight: 600;
                font-size: 16px;
                color: var(--text-secondary);
                position: relative;
                transition: all 0.2s;
            }

            .tab.active {
                color: var(--text-primary);
            }

            .tab.active::after {
                content: '';
                position: absolute;
                bottom: -1px;
                left: 0;
                width: 100%;
                height: 2px;
                background-color: var(--text-primary);
            }

            /* Grid Layouts */
            .grid-terms {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 16px;
            }

            .term-card {
                background-color: var(--surface-color);
                border-radius: 20px;
                padding: 24px;
                transition: transform 0.2s, background-color 0.2s;
            }

            .term-card:hover {
                background-color: var(--surface-hover);
            }

            .term-head {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
            }

            .term-label {
                font-size: 18px;
                font-weight: 700;
            }

            .term-id {
                font-size: 11px;
                color: var(--text-tertiary);
                background: #191919;
                padding: 4px 8px;
                border-radius: 6px;
                font-family: monospace;
            }

            .term-aliases {
                font-size: 14px;
                color: var(--text-secondary);
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 12px;
            }

            .alias-tag {
                background: rgba(255, 255, 255, 0.05);
                padding: 4px 10px;
                border-radius: 6px;
                font-size: 13px;
            }

            /* Logic List */
            .logic-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .logic-item {
                background-color: var(--surface-color);
                border-radius: 20px;
                padding: 24px;
                display: flex;
                align-items: center;
                gap: 24px;
                flex-wrap: wrap;
            }

            .node-pill {
                background: #333;
                padding: 10px 20px;
                border-radius: 14px;
                font-weight: 600;
                font-size: 15px;
                color: #eee;
            }

            .relation-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex: 0 0 auto;
                color: var(--text-tertiary);
                gap: 4px;
            }

            .arrow-line {
                width: 60px;
                height: 2px;
                background: #444;
                position: relative;
            }

            .arrow-line::after {
                content: '';
                position: absolute;
                right: 0;
                top: -3px;
                border-top: 4px solid transparent;
                border-bottom: 4px solid transparent;
                border-left: 6px solid #444;
            }

            .predicate-text {
                font-size: 13px;
                font-weight: 600;
            }

            .text-increase {
                color: #34c759;
            }

            .text-decrease {
                color: #ef4444;
            }

            .text-neutral {
                color: #b0b8c1;
            }

            .condition-text {
                margin-left: auto;
                font-size: 13px;
                color: var(--text-tertiary);
                background: #191919;
                padding: 6px 12px;
                border-radius: 8px;
            }

            /* Search styling */
            .search-bar {
                width: 100%;
                background: var(--surface-color);
                border: none;
                padding: 18px;
                border-radius: 16px;
                color: white;
                font-size: 16px;
                margin-bottom: 32px;
                box-sizing: border-box;
                font-family: inherit;
            }

            .search-bar:focus {
                outline: none;
                box-shadow: 0 0 0 2px var(--primary);
            }

            .search-bar::placeholder {
                color: var(--text-tertiary);
            }
        </style>
    </head>

<body>

    <!-- Sidebar -->
    <nav class="sidebar">
        <a href="/" class="brand">OntoFin</a>

        <a href="/" class="nav-item">대시보드</a>
        <a href="/graph_view" class="nav-item active">지식 그래프</a>

        <div class="nav-divider"></div>

        <div style="font-size:12px; color:var(--text-tertiary); padding: 0 16px; margin-bottom:12px;">바로가기</div>
        <div class="nav-item" style="cursor:pointer; opacity:0.5;">설정 (준비중)</div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <header>
            <h1>금융 지식 저장소</h1>
            <div class="subtitle">AI가 학습하고 보유 중인 모든 금융 개념과 인과 관계를 한눈에 확인합니다.</div>
        </header>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="stat-terms">0</div>
                <div class="stat-label">학습된 용어</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-relations">0</div>
                <div class="stat-label">인과 규칙</div>
            </div>
        </div>

        <input type="text" class="search-bar" id="searchInput" placeholder="검색어를 입력하세요 (용어, 관계 등)..."
            onkeyup="filterContent()">

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('terms')">금융 용어</div>
            <div class="tab" onclick="switchTab('logic')">인과 논리</div>
        </div>

        <!-- Content Terms -->
        <div id="view-terms" class="grid-terms">
            <!-- Dynamic Content -->
        </div>

        <!-- Content Logic -->
        <div id="view-logic" class="logic-list" style="display: none;">
            <!-- Dynamic Content -->
        </div>

    </main>

    <script>
        let rawData = { nodes: [], links: [] };

        async function init() {
            try {
                const res = await fetch('/api/v1/graph');
                rawData = await res.json();
                render();

                // Auto Focus Logic
                const params = new URLSearchParams(window.location.search);
                const focusId = params.get('focus');
                if (focusId) {
                    focusNode(focusId);
                }
            } catch (e) {
                console.error("Failed to load graph data", e);
            }
        }

        function focusNode(termId) {
            // 1. Switch to Terms tab if not active
            switchTab('terms');

            // 2. Filter using the existing filter function
            // But we need to be smart, maybe just scroll to it?

            // Find grid item
            const cards = document.querySelectorAll('.term-card');
            let targetCard = null;

            cards.forEach(card => {
                const idText = card.querySelector('.term-id').innerText;
                if (idText === termId) {
                    targetCard = card;
                    card.style.display = 'block';
                    card.style.border = '2px solid var(--primary)';
                    card.style.backgroundColor = 'rgba(49, 130, 246, 0.1)';
                } else {
                    // logic to hide others if we want "exclusive focus", 
                    // but usually "scrolling to it" is better.
                    // Let's just scroll.
                }
            });

            if (targetCard) {
                targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }


        function render() {
            // Stats
            document.getElementById('stat-terms').innerText = rawData.nodes.length;
            document.getElementById('stat-relations').innerText = rawData.links.length;

            renderTerms(rawData.nodes);
            renderLogic(rawData.links);
        }

        function renderTerms(nodes) {
            const container = document.getElementById('view-terms');
            container.innerHTML = "";

            nodes.forEach(node => {
                const aliasHtml = (node.aliases || []).map(a => `<span class="alias-tag">${a}</span>`).join('');

                const html = `
                <div class="term-card" data-search="${node.label} ${node.id} ${(node.aliases || []).join(' ')}">
                    <div class="term-head">
                        <div class="term-label">${node.label}</div>
                        <div class="term-id">${node.id}</div>
                    </div>
                    ${aliasHtml ? `<div class="term-aliases">${aliasHtml}</div>` : ''}
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function renderLogic(links) {
            const container = document.getElementById('view-logic');
            container.innerHTML = "";

            links.forEach(link => {
                const sourceNode = rawData.nodes.find(n => n.id === link.source);
                const targetNode = rawData.nodes.find(n => n.id === link.target);

                const sLabel = sourceNode ? sourceNode.label : link.source;
                const tLabel = targetNode ? targetNode.label : link.target;

                const { text, cls } = getPredicateStyle(link.predicate);
                const conditions = link.conditions && Object.keys(link.conditions).length > 0
                    ? JSON.stringify(link.conditions).replace(/"/g, '').replace(/{|}/g, '')
                    : "";

                const html = `
                <div class="logic-item" data-search="${sLabel} ${tLabel} ${text}">
                    <div class="node-pill">${sLabel}</div>
                    <div class="relation-container">
                        <div class="predicate-text ${cls}">${text}</div>
                        <div class="arrow-line"></div>
                    </div>
                    <div class="node-pill">${tLabel}</div>
                    ${conditions ? `<div class="condition-text">조건: ${conditions}</div>` : ''}
                </div>
                `;
                container.innerHTML += html;
            });
        }

        function getPredicateStyle(pred) {
            if (pred.includes("INCREASES")) return { text: "증가시킴", cls: "text-increase" };
            if (pred.includes("DECREASES")) return { text: "감소시킴", cls: "text-decrease" };
            if (pred.includes("PREVENTS")) return { text: "저지함", cls: "text-decrease" };
            return { text: "영향을 줌", cls: "text-neutral" };
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'terms') {
                document.getElementById('view-terms').style.display = 'grid';
                document.getElementById('view-logic').style.display = 'none';
            } else {
                document.getElementById('view-terms').style.display = 'none';
                document.getElementById('view-logic').style.display = 'flex';
            }
        }

        function filterContent() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            // Filter Terms
            document.querySelectorAll('.term-card').forEach(card => {
                const txt = card.getAttribute('data-search').toLowerCase();
                card.style.display = txt.includes(query) ? 'block' : 'none';
            });

            // Filter Logic
            document.querySelectorAll('.logic-item').forEach(item => {
                const txt = item.getAttribute('data-search').toLowerCase();
                item.style.display = txt.includes(query) ? 'flex' : 'none';
            });
        }

        init();
    </script>
</body>

</html>